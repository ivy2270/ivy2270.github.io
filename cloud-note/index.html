<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é›²ç«¯è¨˜äº‹æœ¬</title>
  <link href="https://font.emtech.cc/css/jfOpenHuninn" rel="stylesheet" />
  <link rel="icon" type="image/svg+xml" href="note-notepad-svgrepo-com.svg">
  <link id="manifest-link" rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#e7d3ed">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="é›²ç«¯ç­†è¨˜">
  <link rel="apple-touch-icon" href="https://rainchord.s3.ap-east-2.amazonaws.com/inventory/1768709528671_note.png">
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  
  <style>
    :root {
      /* å„ªé›…è–°è¡£è‰ç´«é…è‰²æ–¹æ¡ˆ */
      --bg-color: #f8f4fa;           /* æ¥µæ·ºç´«èƒŒæ™¯ */
      --pattern-color: #eaddf0;      /* èƒŒæ™¯åœ“é» */
      --card-bg-color: #ffffff;
      --primary-text-color: #4a444d; /* æ·±ç´«ç° */
      --secondary-text-color: #908695;
      --border-color: #e7d3ed;       /* è–°è¡£è‰ç´«é‚Šæ¡† */
      --accent-color: #a38dbd;       /* ä¸­ç´«ï¼ˆä¸»è‰²èª¿ï¼‰ */
      --tag-bg: #e3f2fd;             /* æ·¡è—æ¨™ç±¤ */
      --tag-text: #47789a;
      --danger-color: #edadaa;       /* æŸ”ç²‰ç´… */
      --edit-color: #b8ccb1;         /* æŸ”ç¶  */
      --copy-color: #f2e9bc;         /* æŸ”é»ƒ */
    }

    body {
      font-family: 'JFOpenHuninn', -apple-system, sans-serif;
      background-color: var(--bg-color);
      background-image: radial-gradient(var(--pattern-color) 1.5px, transparent 0);
      background-size: 35px 35px;
      color: var(--primary-text-color);
      margin: 0; padding: 24px; display: flex; justify-content: center;
    }

    #app-container { width: 100%; max-width: 1000px; }
    h1 { text-align: center; font-weight: 700; color: var(--accent-color); margin-bottom: 32px; letter-spacing: 2px; }

    /* è¼¸å…¥å€åŸŸ */
    .input-area {
      background: var(--card-bg-color); padding: 24px; border-radius: 20px;
      box-shadow: 0 4px 15px rgba(163, 141, 189, 0.15); margin-bottom: 32px; 
      border: 2px solid var(--border-color);
    }
    #note-input {
      width: 100%; min-height: 90px; padding: 12px; box-sizing: border-box;
      border: 1.5px solid var(--border-color); border-radius: 12px;
      font-size: 16px; line-height: 1.7; resize: vertical; font-family: inherit;
      outline-color: var(--accent-color);
    }
    #add-btn {
      display: block; width: 100%; padding: 14px; margin-top: 16px;
      font-size: 16px; font-weight: bold; color: #fff;
      background-color: var(--accent-color); border: none;
      border-radius: 12px; cursor: pointer; font-family: inherit;
      transition: all 0.3s;
    }
    #add-btn:hover { background-color: #8e74ae; transform: scale(1.01); }

    /* æœå°‹æ¡† */
    #search-input {
      width: 100%; padding: 12px; box-sizing: border-box;
      border: 2px solid var(--border-color); border-radius: 12px;
      margin-bottom: 24px; font-family: inherit;
      box-shadow: 0 2px 10px rgba(163, 141, 189, 0.1);
      outline-color: var(--accent-color);
    }

    /* ä½ˆå±€å®¹å™¨ */
    #notes-container { 
      display: flex; flex-wrap: wrap; gap: 20px; align-items: flex-start; 
    }

    .note-card {
      background: var(--card-bg-color); padding: 20px;
      border-radius: 20px; border: 1.5px solid var(--border-color);
      width: calc(33.333% - 14px);
      box-sizing: border-box;
      transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      cursor: pointer; position: relative;
      user-select: auto;
    }
    @media (max-width: 900px) { .note-card { width: calc(50% - 10px); } }
    @media (max-width: 600px) { .note-card { width: 100%; } }

    .note-card:hover {
      box-shadow: 0 10px 25px rgba(163, 141, 189, 0.2); transform: translateY(-5px);
    }
    
.note-content {
  white-space: pre-wrap; 
  overflow-wrap: break-word;
  word-break: break-all;
  font-size: 15px; 
  line-height: 1.6;
  margin-bottom: 0;       /* ğŸ’¡ æ”¹ç‚º 0ï¼Œé  meta çš„ padding æ’é–‹ */
  position: relative; 
  max-height: 160px; 
  overflow: hidden;
  transition: max-height 0.4s ease;
}

/* ğŸ’¡ æ–°å¢ä¸€å€‹å…§éƒ¨å®¹å™¨ï¼Œç¢ºä¿æ–‡å­—èˆ‡ overlay ä¸æœƒäº’ç›¸æ¨æ“  */
.note-inner {
  display: block;
}
    .note-card.expanded .note-content { max-height:none; }
    .note-content a { color: var(--accent-color); text-decoration: underline; }

    /* æ¼¸å±¤é®ç½© */
    .content-overlay {
      position: absolute; bottom: 0; left: 0; width: 100%; height: 60px;
      background: linear-gradient(transparent, var(--card-bg-color));
      pointer-events: none; transition: opacity 0.3s;
      display: flex; align-items: flex-end; justify-content: center;
      padding-bottom: 5px; color: var(--accent-color); letter-spacing: 3px;
    }
    .note-card.expanded .content-overlay { opacity: 0; }

    .tag-link {
      color: var(--tag-text); background: var(--tag-bg);
      padding: 2px 10px; border-radius: 20px; cursor: pointer;
      text-decoration: none; font-weight: 500; margin-right: 4px;
      display: inline-block; font-size: 13px;
    }

.note-meta {
  font-size: 13px; 
  color: var(--secondary-text-color);
  border-top: 1px dashed var(--border-color); 
  padding-top: 12px;     /* ğŸ’¡ é€™è£¡æ˜¯ TAG ä¸Šæ–¹çš„ç©ºé–“ï¼Œä½ å¯ä»¥æ ¹æ“šå–œå¥½èª¿æ•´ (å¦‚ 8px æˆ– 12px) */
  margin-top: 10px;      /* ğŸ’¡ ç¢ºä¿è™›ç·šèˆ‡æ–‡å­—æœ‰å›ºå®šé–“è· */
  display: flex; 
  flex-direction: column; 
  gap: 8px;
}

    /* åŠŸèƒ½æŒ‰éˆ•çµ±ä¸€åŒ– */
    .note-actions { display: flex; gap: 8px; user-select: none;}
    .note-actions button {
      width: 36px; height: 36px; display: flex; align-items: center; justify-content: center;
      font-size: 14px; border-radius: 10px;
      cursor: pointer; border: none; transition: all 0.2s;
      color: #5d5252;
    }
    .note-actions button:hover { opacity: 0.8; transform: translateY(-2px); }
    .edit-btn, .save-btn { background-color: var(--edit-color); }
    .copy-btn { background-color: var(--copy-color); }
    .delete-btn { background-color: var(--danger-color); }

.edit-textarea {
  width: 100%;
  min-height: 200px; /* ç¨å¾®å¢åŠ é è¨­é«˜åº¦ */
  box-sizing: border-box;
  border: 2px solid var(--accent-color);
  border-radius: 12px;
  font-family: inherit;
  font-size: 15px;
  line-height: 1.7;
  padding: 10px;
  outline: none;
  background: #fff; /* ç¢ºä¿èƒŒæ™¯ä¸é€æ˜ */
}
    
    #loader { text-align: center; padding: 20px; color: var(--accent-color); font-weight: bold; }
    .admin-only { display: none !important; }
    body.admin-mode .admin-only { display: block !important; }
    body.admin-mode button.admin-only { display: flex !important; }
  </style>
</head>
<body>
  <div id="app-container">
    <h1><i class="fa-solid fa-note-sticky"></i> é›²ç«¯è¨˜äº‹æœ¬</h1>
    <div class="input-area admin-only">
      <textarea id="note-input" placeholder="åœ¨é€™è£¡å¯«ä¸‹æ–°çš„æƒ³æ³•..."></textarea>
      <button id="add-btn">æ–°å¢ç­†è¨˜</button>
    </div>
    <input type="text" id="search-input" placeholder="æœå°‹ç­†è¨˜...">
    <div id="loader" style="display:none;"><i class="fa-solid fa-spinner fa-spin"></i> åŒæ­¥ä¸­...</div>
    <div id="notes-container"></div>
  </div>

<script>
const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbz-TLMSRHh_nF2JdlYI28BrhgS0Yu9xqvhEG7yC7IS1ivfxhoer6xOkC44wptJMqCupPg/exec';

// PWA Manifest logic
(function() {
    const params = new URLSearchParams(window.location.search);
    const key = params.get('key');
    const appId = "my-cloud-note-pwa"; 
    let manifestData = {
        "id": appId, "name": "é›²ç«¯è¨˜äº‹æœ¬", "short_name": "é›²ç«¯ç­†è¨˜",
        "start_url": "index.html", "display": "standalone",
        "background_color": "#e7d3ed", "theme_color": "#e7d3ed",
        "icons": [{"src": "https://rainchord.s3.ap-east-2.amazonaws.com/inventory/1768709528671_note.png", "sizes": "192x192", "type": "image/png"}]
    };
    if (key && key.trim() !== "") {
        manifestData.name = "é›²ç«¯è¨˜äº‹æœ¬ (ç®¡ç†ç‰ˆ)";
        manifestData.start_url = "index.html?key=" + key; 
    }
    const blob = new Blob([JSON.stringify(manifestData)], {type: 'application/json'});
    document.getElementById('manifest-link').setAttribute('href', URL.createObjectURL(blob));
})();

function getInitialKey() {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get('key') || null;
}
const USER_KEY = getInitialKey();
if (USER_KEY) document.body.classList.add('admin-mode');

const noteInput = document.getElementById('note-input');
const addBtn = document.getElementById('add-btn');
const notesContainer = document.getElementById('notes-container');
const loader = document.getElementById('loader');
const searchInput = document.getElementById('search-input');

let allNotes = JSON.parse(localStorage.getItem('my_notes_cache') || '[]');

document.addEventListener('DOMContentLoaded', () => {
  renderNotes(); 
  fetchNotesFromServer();
});

async function callApi(action, data = {}) {
  const payload = { action, key: USER_KEY, ...data }; 
  try {
    const response = await fetch(WEB_APP_URL, { method: 'POST', body: JSON.stringify(payload) });
    const result = await response.json();
    if (result.status === 'error' && result.message.includes("æ¬Šé™")) {
        alert("âš ï¸ æ“ä½œå¤±æ•—ï¼šéˆ…åŒ™ç„¡æ•ˆã€‚");
        throw new Error("Unauthorized");
    }
    return result;
  } catch (err) { console.error('API Error:', err); throw err; }
}

async function fetchNotesFromServer() {
  loader.style.display = 'block';
  try {
    const notes = await callApi('getNotes');
    allNotes = notes;
    localStorage.setItem('my_notes_cache', JSON.stringify(allNotes));
    renderNotes();
  } catch (err) { console.log('ä½¿ç”¨å¿«å–å…§å®¹'); }
  finally { loader.style.display = 'none'; }
}

function processContent(text) {
  // 1. å…ˆè™•ç† HTML è½‰ç¾©ï¼Œç¢ºä¿ç­†è¨˜å…§çš„ <script> ç­‰ä¸æœƒè¢«åŸ·è¡Œ
  let safeContent = escapeHtml(text);
  
  // 2. è™•ç† URLï¼šå°‡ç¶²å€è½‰ç‚ºå¯é»æ“Šé€£çµ
  const urlPattern = /(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;
  safeContent = safeContent.replace(urlPattern, url => `<a href="${url}" target="_blank" rel="noopener noreferrer">${url}</a>`);
  
  // 3. è™•ç† #TAGï¼šä¿®æ­£æ­£å‰‡è¡¨é”å¼ï¼Œé¿å…èª¤åˆ¤ä»£ç¢¼ä¸­çš„é¡è‰²å€¼ (#ffffff)
  // è¦å‰‡ï¼š# å‰é¢å¿…é ˆæ˜¯ç©ºæ ¼æˆ–æ›è¡Œï¼Œæˆ–è€…æ˜¯å­—ä¸²é–‹é ­
  const tagPattern = /(^|\s)#([^\s#]+)/g;
  return safeContent.replace(tagPattern, (match, space, tagName) => {
    return `${space}<span class="tag-link" data-tag="${tagName}">#${tagName}</span>`;
  });
}

function renderNotes() {
  const searchTerm = searchInput.value.toLowerCase();
  notesContainer.innerHTML = '';
  const filtered = allNotes
    .filter(n => n.content.toLowerCase().includes(searchTerm))
    .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

  filtered.forEach(note => {
    const card = document.createElement('div');
    card.className = 'note-card';
    card.dataset.id = note.id;
    const contentHtml = processContent(note.content);

    // ğŸ’¡ é—œéµä¿®æ­£ï¼šå°‡ HTML æ¨™ç±¤é€£åœ¨ä¸€èµ·å¯«ï¼Œä¸­é–“ä¸è¦æœ‰æ›è¡Œæˆ–ç©ºæ ¼
    card.innerHTML = `<div class="note-content"><div class="note-inner">${contentHtml}</div><div class="content-overlay">...</div></div><div class="note-meta"><span>${new Date(note.timestamp).toLocaleString()}</span><div class="note-actions"><button class="edit-btn admin-only" title="ç·¨è¼¯"><i class="fa-solid fa-pen"></i></button><button class="copy-btn" title="è¤‡è£½"><i class="fa-regular fa-copy"></i></button><button class="delete-btn admin-only" title="åˆªé™¤"><i class="fa-solid fa-trash-can"></i></button></div></div>`;
    
    notesContainer.appendChild(card);
    
    const contentDiv = card.querySelector('.note-content');
    const innerDiv = card.querySelector('.note-inner');
    
    if (innerDiv.scrollHeight <= 160) {
      contentDiv.style.maxHeight = 'none';
      card.querySelector('.content-overlay').style.display = 'none';
    }
  });
}

notesContainer.addEventListener('click', (e) => {
  const target = e.target.closest('button') || e.target;
  const card = target.closest('.note-card');
  if (!card) return;
  const id = card.dataset.id;
  // 1. å¦‚æœé¸å–çš„ç›®æ¨™æ˜¯é€£çµ <a>ï¼Œå‰‡äº¤ç”±ç€è¦½å™¨è™•ç†ç¶²å€è·³è½‰ï¼Œä¸è§¸ç™¼å±•é–‹
  if (target.tagName === 'A') return;

  // 2. å¦‚æœä½¿ç”¨è€…æ­£åœ¨æ»‘é¼ é¸å–æ–‡å­—ï¼ˆä¾‹å¦‚æº–å‚™è¤‡è£½ä»£ç¢¼ï¼‰ï¼Œå‰‡ä¸è§¸ç™¼å±•é–‹
  if (window.getSelection().toString()) return;

  if (target.classList.contains('tag-link')) {
    const tagName = target.dataset.tag;
    searchInput.value = (searchInput.value === `#${tagName}`) ? '' : `#${tagName}`;
    renderNotes();
    return;
  }

  if (target.tagName === 'BUTTON' || target.tagName === 'A' || target.tagName === 'TEXTAREA') {
    if (target.classList.contains('edit-btn')) switchToEditMode(card, target);
    else if (target.classList.contains('save-btn')) saveNote(id, card, target);
    else if (target.classList.contains('copy-btn')) copyNote(card, target);
    else if (target.classList.contains('delete-btn')) deleteNote(id, card);
    return;
  }

  const contentDiv = card.querySelector('.note-content');
  if (contentDiv.scrollHeight > 160) {
    card.classList.toggle('expanded');
  }
});

async function addNewNote() {
  const content = noteInput.value.trim();
  if (!content) return alert('å…§å®¹ä¸èƒ½ç‚ºç©ºï¼');
  addBtn.disabled = true; addBtn.innerText = 'æ–°å¢ä¸­...';
  try {
    const res = await callApi('addNote', { content });
    if (res.status === 'success') {
      allNotes.unshift(res.note);
      localStorage.setItem('my_notes_cache', JSON.stringify(allNotes));
      noteInput.value = ''; renderNotes();
    }
  } finally { addBtn.disabled = false; addBtn.innerText = 'æ–°å¢ç­†è¨˜'; }
}

function switchToEditMode(card, button) {
  const contentDiv = card.querySelector('.note-content');
  const note = allNotes.find(n => n.id === card.dataset.id);
  card.classList.add('expanded');
  contentDiv.innerHTML = `<textarea class="edit-textarea">${note.content}</textarea>`;
  contentDiv.querySelector('textarea').focus();
  button.innerHTML = '<i class="fa-solid fa-floppy-disk"></i>'; 
  button.classList.replace('edit-btn', 'save-btn');
}

async function saveNote(id, card, button) {
  const newContent = card.querySelector('.edit-textarea').value;
  button.disabled = true; button.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
  try {
    const res = await callApi('editNote', { id, content: newContent });
    if (res.status === 'success') {
      const note = allNotes.find(n => n.id === id);
      note.content = newContent;
      note.timestamp = new Date().toISOString();
      localStorage.setItem('my_notes_cache', JSON.stringify(allNotes));
      renderNotes();
    }
  } finally { button.disabled = false; }
}

// ä¿®æ”¹å¾Œçš„è¤‡è£½åŠŸèƒ½ï¼šè‡ªå‹•æ’é™¤ #TAG
function copyNote(card, button) {
  const note = allNotes.find(n => n.id === card.dataset.id);
  
  // ä¿®æ­£ï¼šåªæœ‰åœ¨è¡Œé¦–æˆ–ç©ºæ ¼å¾Œçš„ # æ‰è¢«è¦–ç‚ºæ¨™ç±¤ä¸¦ç§»é™¤
  // é€™æ¨£å°±ä¸æœƒèª¤åˆªä»£ç¢¼ä¸­çš„è‰²ç¢¼ (å¦‚ #ffffff)
  const cleanContent = note.content.replace(/(^|\s)#[^\s#]+\s?/g, '$1').trim();
  
  navigator.clipboard.writeText(cleanContent).then(() => {
    const oldHtml = button.innerHTML;
    button.innerHTML = '<i class="fa-solid fa-check"></i>';
    setTimeout(() => { button.innerHTML = oldHtml; }, 2000);
  });
}

async function deleteNote(id, card) {
  if (confirm('è¦åˆªé™¤é€™å‰‡å°ç­†è¨˜å—ï¼Ÿ')) {
    try {
      const res = await callApi('deleteNote', { id });
      if (res.status === 'success') {
        allNotes = allNotes.filter(n => n.id !== id);
        localStorage.setItem('my_notes_cache', JSON.stringify(allNotes));
        card.remove();
      }
    } catch(e) {}
  }
}

searchInput.addEventListener('input', renderNotes);
addBtn.addEventListener('click', addNewNote);
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('sw.js').catch(err => console.log(err));
  });
}
</script>
</body>
</html>
