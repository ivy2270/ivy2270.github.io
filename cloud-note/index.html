<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>雲端記事本</title>
  <link href="https://font.emtech.cc/css/jfOpenHuninn" rel="stylesheet" />
  <link rel="icon" type="image/svg+xml" href="note-notepad-svgrepo-com.svg">
  <link id="manifest-link" rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#e7d3ed">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="雲端筆記">
  <link rel="apple-touch-icon" href="https://rainchord.s3.ap-east-2.amazonaws.com/inventory/1768709528671_note.png">
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  
  <style>
    :root {
      /* 優雅薰衣草紫配色方案 */
      --bg-color: #f8f4fa;           /* 極淺紫背景 */
      --pattern-color: #eaddf0;      /* 背景圓點 */
      --card-bg-color: #ffffff;
      --primary-text-color: #4a444d; /* 深紫灰 */
      --secondary-text-color: #908695;
      --border-color: #e7d3ed;       /* 薰衣草紫邊框 */
      --accent-color: #a38dbd;       /* 中紫（主色調） */
      --tag-bg: #e3f2fd;             /* 淡藍標籤 */
      --tag-text: #47789a;
      --danger-color: #edadaa;       /* 柔粉紅 */
      --edit-color: #b8ccb1;         /* 柔綠 */
      --copy-color: #f2e9bc;         /* 柔黃 */
    }

    body {
      font-family: 'JFOpenHuninn', -apple-system, sans-serif;
      background-color: var(--bg-color);
      background-image: radial-gradient(var(--pattern-color) 1.5px, transparent 0);
      background-size: 35px 35px;
      color: var(--primary-text-color);
      margin: 0; padding: 24px; display: flex; justify-content: center;
    }

    #app-container { width: 100%; max-width: 1000px; }
    h1 { text-align: center; font-weight: 700; color: var(--accent-color); margin-bottom: 32px; letter-spacing: 2px; }

    /* 輸入區域 */
    .input-area {
      background: var(--card-bg-color); padding: 24px; border-radius: 20px;
      box-shadow: 0 4px 15px rgba(163, 141, 189, 0.15); margin-bottom: 32px; 
      border: 2px solid var(--border-color);
    }
    #note-input {
      width: 100%; min-height: 90px; padding: 12px; box-sizing: border-box;
      border: 1.5px solid var(--border-color); border-radius: 12px;
      font-size: 16px; line-height: 1.7; resize: vertical; font-family: inherit;
      outline-color: var(--accent-color);
    }
    #add-btn {
      display: block; width: 100%; padding: 14px; margin-top: 16px;
      font-size: 16px; font-weight: bold; color: #fff;
      background-color: var(--accent-color); border: none;
      border-radius: 12px; cursor: pointer; font-family: inherit;
      transition: all 0.3s;
    }
    #add-btn:hover { background-color: #8e74ae; transform: scale(1.01); }

    /* 搜尋框 */
    #search-input {
      width: 100%; padding: 12px; box-sizing: border-box;
      border: 2px solid var(--border-color); border-radius: 12px;
      margin-bottom: 24px; font-family: inherit;
      box-shadow: 0 2px 10px rgba(163, 141, 189, 0.1);
      outline-color: var(--accent-color);
    }

    /* 佈局容器 */
    #notes-container { 
      display: flex; flex-wrap: wrap; gap: 20px; align-items: flex-start; 
    }

    .note-card {
      background: var(--card-bg-color); padding: 20px;
      border-radius: 20px; border: 1.5px solid var(--border-color);
      width: calc(33.333% - 14px);
      box-sizing: border-box;
      transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      cursor: pointer; position: relative;
      user-select: none;
    }
    @media (max-width: 900px) { .note-card { width: calc(50% - 10px); } }
    @media (max-width: 600px) { .note-card { width: 100%; } }

    .note-card:hover {
      box-shadow: 0 10px 25px rgba(163, 141, 189, 0.2); transform: translateY(-5px);
    }
    
    .note-content {
      white-space: pre-wrap; overflow-wrap: break-word;
      font-size: 15px; line-height: 1.7; margin-bottom: 12px;
      position: relative; max-height: 160px; overflow: hidden;
      transition: max-height 0.5s ease;
      user-select: text;
    }
    .note-card.expanded .note-content { max-height: 2000px; }
    .note-content a { color: var(--accent-color); text-decoration: underline; }

    /* 漸層遮罩 */
    .content-overlay {
      position: absolute; bottom: 0; left: 0; width: 100%; height: 60px;
      background: linear-gradient(transparent, var(--card-bg-color));
      pointer-events: none; transition: opacity 0.3s;
      display: flex; align-items: flex-end; justify-content: center;
      padding-bottom: 5px; color: var(--accent-color); letter-spacing: 3px;
    }
    .note-card.expanded .content-overlay { opacity: 0; }

    .tag-link {
      color: var(--tag-text); background: var(--tag-bg);
      padding: 2px 10px; border-radius: 20px; cursor: pointer;
      text-decoration: none; font-weight: 500; margin-right: 4px;
      display: inline-block; font-size: 13px;
    }

    .note-meta {
      font-size: 13px; color: var(--secondary-text-color);
      border-top: 1px dashed var(--border-color); padding-top: 12px;
      display: flex; flex-direction: column; gap: 12px;
    }

    /* 功能按鈕統一化 */
    .note-actions { display: flex; gap: 8px; }
    .note-actions button {
      width: 36px; height: 36px; display: flex; align-items: center; justify-content: center;
      font-size: 14px; border-radius: 10px;
      cursor: pointer; border: none; transition: all 0.2s;
      color: #5d5252;
    }
    .note-actions button:hover { opacity: 0.8; transform: translateY(-2px); }
    .edit-btn, .save-btn { background-color: var(--edit-color); }
    .copy-btn { background-color: var(--copy-color); }
    .delete-btn { background-color: var(--danger-color); }

    .edit-textarea {
      width: 100%; min-height: 120px; box-sizing: border-box;
      border: 2px solid var(--accent-color); border-radius: 12px;
      font-family: inherit; font-size: 15px; line-height: 1.7; padding: 10px;
      outline: none;
    }
    
    #loader { text-align: center; padding: 20px; color: var(--accent-color); font-weight: bold; }
    .admin-only { display: none !important; }
    body.admin-mode .admin-only { display: block !important; }
    body.admin-mode button.admin-only { display: flex !important; } /* 注意這裡是 flex */
  </style>
</head>
<body>
  <div id="app-container">
    <h1><i class="fa-solid fa-note-sticky"></i> 雲端記事本</h1>
    <div class="input-area admin-only">
      <textarea id="note-input" placeholder="在這裡寫下新的想法..."></textarea>
      <button id="add-btn">新增筆記</button>
    </div>
    <input type="text" id="search-input" placeholder="搜尋筆記...">
    <div id="loader" style="display:none;"><i class="fa-solid fa-spinner fa-spin"></i> 同步中...</div>
    <div id="notes-container"></div>
  </div>

<script>
const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbz-TLMSRHh_nF2JdlYI28BrhgS0Yu9xqvhEG7yC7IS1ivfxhoer6xOkC44wptJMqCupPg/exec';

// PWA Manifest logic
(function() {
    const params = new URLSearchParams(window.location.search);
    const key = params.get('key');
    const appId = "my-cloud-note-pwa"; 
    let manifestData = {
        "id": appId, "name": "雲端記事本", "short_name": "雲端筆記",
        "start_url": "index.html", "display": "standalone",
        "background_color": "#e7d3ed", "theme_color": "#e7d3ed",
        "icons": [{"src": "https://rainchord.s3.ap-east-2.amazonaws.com/inventory/1768709528671_note.png", "sizes": "192x192", "type": "image/png"}]
    };
    if (key && key.trim() !== "") {
        manifestData.name = "雲端記事本 (管理版)";
        manifestData.start_url = "index.html?key=" + key; 
    }
    const blob = new Blob([JSON.stringify(manifestData)], {type: 'application/json'});
    document.getElementById('manifest-link').setAttribute('href', URL.createObjectURL(blob));
})();

function getInitialKey() {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get('key') || null;
}
const USER_KEY = getInitialKey();
if (USER_KEY) document.body.classList.add('admin-mode');

const noteInput = document.getElementById('note-input');
const addBtn = document.getElementById('add-btn');
const notesContainer = document.getElementById('notes-container');
const loader = document.getElementById('loader');
const searchInput = document.getElementById('search-input');

let allNotes = JSON.parse(localStorage.getItem('my_notes_cache') || '[]');

document.addEventListener('DOMContentLoaded', () => {
  renderNotes(); 
  fetchNotesFromServer();
});

async function callApi(action, data = {}) {
  const payload = { action, key: USER_KEY, ...data }; 
  try {
    const response = await fetch(WEB_APP_URL, { method: 'POST', body: JSON.stringify(payload) });
    const result = await response.json();
    if (result.status === 'error' && result.message.includes("權限")) {
        alert("⚠️ 操作失敗：鈅匙無效。");
        throw new Error("Unauthorized");
    }
    return result;
  } catch (err) { console.error('API Error:', err); throw err; }
}

async function fetchNotesFromServer() {
  loader.style.display = 'block';
  try {
    const notes = await callApi('getNotes');
    allNotes = notes;
    localStorage.setItem('my_notes_cache', JSON.stringify(allNotes));
    renderNotes();
  } catch (err) { console.log('使用快取內容'); }
  finally { loader.style.display = 'none'; }
}

function processContent(text) {
  const safeContent = escapeHtml(text);
  const urlPattern = /(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;
  let formatted = safeContent.replace(urlPattern, url => `<a href="${url}" target="_blank" rel="noopener noreferrer">${url}</a>`);
  const tagPattern = /#([^\s#]+)/g;
  return formatted.replace(tagPattern, (match, tagName) => `<span class="tag-link" data-tag="${tagName}">${match}</span>`);
}

function renderNotes() {
  const searchTerm = searchInput.value.toLowerCase();
  notesContainer.innerHTML = '';
  const filtered = allNotes
    .filter(n => n.content.toLowerCase().includes(searchTerm))
    .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

  filtered.forEach(note => {
    const card = document.createElement('div');
    card.className = 'note-card';
    card.dataset.id = note.id;
    const contentHtml = processContent(note.content);

    card.innerHTML = `
      <div class="note-content">${contentHtml}<div class="content-overlay">...</div></div>
      <div class="note-meta">
        <span>${new Date(note.timestamp).toLocaleString()}</span>
        <div class="note-actions">
          <button class="edit-btn admin-only" title="編輯"><i class="fa-solid fa-pen"></i></button>
          <button class="copy-btn" title="複製"><i class="fa-regular fa-copy"></i></button>
          <button class="delete-btn admin-only" title="刪除"><i class="fa-solid fa-trash-can"></i></button>
        </div>
      </div>`;
    
    notesContainer.appendChild(card);
    const contentDiv = card.querySelector('.note-content');
    if (contentDiv.scrollHeight <= 160) {
      card.querySelector('.content-overlay').style.display = 'none';
    }
  });
}

notesContainer.addEventListener('click', (e) => {
  const target = e.target.closest('button') || e.target;
  const card = target.closest('.note-card');
  if (!card) return;
  const id = card.dataset.id;

  if (target.classList.contains('tag-link')) {
    const tagName = target.dataset.tag;
    searchInput.value = (searchInput.value === `#${tagName}`) ? '' : `#${tagName}`;
    renderNotes();
    return;
  }

  if (target.tagName === 'BUTTON' || target.tagName === 'A' || target.tagName === 'TEXTAREA') {
    if (target.classList.contains('edit-btn')) switchToEditMode(card, target);
    else if (target.classList.contains('save-btn')) saveNote(id, card, target);
    else if (target.classList.contains('copy-btn')) copyNote(card, target);
    else if (target.classList.contains('delete-btn')) deleteNote(id, card);
    return;
  }

  const contentDiv = card.querySelector('.note-content');
  if (contentDiv.scrollHeight > 160) {
    card.classList.toggle('expanded');
  }
});

async function addNewNote() {
  const content = noteInput.value.trim();
  if (!content) return alert('內容不能為空！');
  addBtn.disabled = true; addBtn.innerText = '新增中...';
  try {
    const res = await callApi('addNote', { content });
    if (res.status === 'success') {
      allNotes.unshift(res.note);
      localStorage.setItem('my_notes_cache', JSON.stringify(allNotes));
      noteInput.value = ''; renderNotes();
    }
  } finally { addBtn.disabled = false; addBtn.innerText = '新增筆記'; }
}

function switchToEditMode(card, button) {
  const contentDiv = card.querySelector('.note-content');
  const note = allNotes.find(n => n.id === card.dataset.id);
  card.classList.add('expanded');
  contentDiv.innerHTML = `<textarea class="edit-textarea">${note.content}</textarea>`;
  contentDiv.querySelector('textarea').focus();
  button.innerHTML = '<i class="fa-solid fa-floppy-disk"></i>'; 
  button.classList.replace('edit-btn', 'save-btn');
}

async function saveNote(id, card, button) {
  const newContent = card.querySelector('.edit-textarea').value;
  button.disabled = true; button.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
  try {
    const res = await callApi('editNote', { id, content: newContent });
    if (res.status === 'success') {
      const note = allNotes.find(n => n.id === id);
      note.content = newContent;
      note.timestamp = new Date().toISOString();
      localStorage.setItem('my_notes_cache', JSON.stringify(allNotes));
      renderNotes();
    }
  } finally { button.disabled = false; }
}

function copyNote(card, button) {
  const note = allNotes.find(n => n.id === card.dataset.id);
  navigator.clipboard.writeText(note.content).then(() => {
    const oldHtml = button.innerHTML;
    button.innerHTML = '<i class="fa-solid fa-check"></i>';
    setTimeout(() => { button.innerHTML = oldHtml; }, 2000);
  });
}

async function deleteNote(id, card) {
  if (confirm('要刪除這則小筆記嗎？')) {
    try {
      const res = await callApi('deleteNote', { id });
      if (res.status === 'success') {
        allNotes = allNotes.filter(n => n.id !== id);
        localStorage.setItem('my_notes_cache', JSON.stringify(allNotes));
        card.remove();
      }
    } catch(e) {}
  }
}

searchInput.addEventListener('input', renderNotes);
addBtn.addEventListener('click', addNewNote);
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('sw.js').catch(err => console.log(err));
  });
}
</script>
</body>
</html>
