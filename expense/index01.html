<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÂæÆÊôÇË®òÂ∏≥ - Á∞°Á¥ÑÁîüÊ¥ªÂ∞èÂ∑•ÂÖ∑</title>
    <link rel="icon" type="image/svg+xml" href="money-bag-money-svgrepo-com.svg">
    <link rel="stylesheet" href="style01.css">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <link id="manifest-link" rel="manifest" href="manifest.json">
    <link rel="preload" href="https://ymdd-image-tw.s3.ap-east-2.amazonaws.com/font/jf-openhuninn-2.1.ttf" as="font" type="font/ttf" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
</head>
<body>
    <div id="app" class="container" v-cloak>   
    
        <h2 style="text-align: center; color: var(--primary); margin: 20px 0;">üéÄ {{ currentTabTitle }}</h2>

        <transition name="tab-content-fade" mode="out-in">
            <div :key="activeTab">
                <div v-if="activeTab === 'list'">
                    
                    <div class="filter-toolbar">
                        <div class="filter-summary">
                            <i class="fa-regular fa-calendar-days"></i>
                            <span>{{ filter.start }} ~ {{ filter.end }}</span>
                        </div>
                        <button class="filter-toggle-btn" :class="{active: showFilterPanel}" @click="showFilterPanel = !showFilterPanel">
                            <i class="fa-solid fa-sliders"></i>
                        </button>
                    </div>

                    <transition name="slide-fade">
                        <div class="filter-panel" v-if="showFilterPanel">
                            <div class="filter-grid">
                                <div class="filter-input-group">
                                    <label>ÈñãÂßãÊó•Êúü</label>
                                    <input type="date" v-model="filter.start">
                                </div>
                                <div class="filter-input-group">
                                    <label>ÁµêÊùüÊó•Êúü</label>
                                    <input type="date" v-model="filter.end">
                                </div>
                                <div class="filter-input-group">
                                    <label>ÂàÜÈ°ûÁØ©ÈÅ∏</label>
                                    <select v-model="filter.mainCategory">
                                        <option value="">ÂÖ®ÈÉ®È°ûÂà•</option>
                                        <option v-for="cat in categoryData" :value="cat.main">{{ cat.main }}</option>
                                    </select>
                                </div>
                                <div class="filter-input-group">
                                    <label>‰ªòÊ¨æÊñπÂºè</label>
                                    <select v-model="filter.payment">
                                        <option value="">ÂÖ®ÈÉ®ÊñπÂºè</option>
                                        <option v-for="p in payments" :value="p">{{ p }}</option>
                                    </select>
                                </div>
                                <div class="filter-input-group full-width">
                                    <label>ÈóúÈçµÂ≠óÊêúÂ∞ã</label>
                                    <input type="text" v-model="filter.keyword" placeholder="ÊêúÂ∞ãÂìÅÈ†ÖÊàñÂÇôË®ª...">
                                </div>
                            </div>
                        </div>
                    </transition>

                    <div class="card log-item" v-for="item in processedLogs" :key="item.ID" @click="editLog(item)">
                        <div style="display: flex; align-items: center;">
                            <div class="thumb-box">
                                <img v-if="item.imageUrl" :src="item.imageUrl" class="thumb" @click.stop="openLightbox(item.imageUrl)">
                                <div v-else class="thumb-placeholder">üí∞</div>
                            </div>
                            <div style="flex: 1;">
                                <div style="display: flex; justify-content: space-between;">
                                    <strong style="font-size: 1.1em;">{{ item.ÂìÅÈ†Ö }}</strong>
                                    <span style="color: #ff7675; font-weight: bold;">${{ item.ÈáëÈ°ç }}</span>
                                </div>
                                <div style="font-size: 12px; color: #999; margin-top: 5px;">
                                    {{ item.displayDate }} | <span class="tag">{{ item.Â∞èÂàÜÈ°û }}</span> | {{ item.‰ªòÊ¨æÊñπÂºè }}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div v-if="processedLogs.length === 0" style="text-align:center; color:#ccc; margin-top:50px;">
                        Êâæ‰∏çÂà∞Á¨¶ÂêàÊ¢ù‰ª∂ÁöÑÂ∏≥ÁõÆÂñîÔºÅ
                    </div>
                </div>

                <div v-if="activeTab === 'chart'">
                    <div class="card">
                        <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 20px;">
                            <input type="date" v-model="filter.start" class="date-input">
                            Ëá≥
                            <input type="date" v-model="filter.end" class="date-input">
                        </div>
                        <div style="position: relative; height:300px;">
                            <canvas id="myChart"></canvas>
                        </div>
                    </div>
                    <div class="card"><p>Á∏ΩÊîØÂá∫Ôºö<strong style="color: #ff7675;">${{ totalExpense }}</strong></p></div>
                </div>

                <div v-if="activeTab === 'settings'">
                    <div class="card">
                        <h3>üìÇ ÂàÜÈ°ûÁÆ°ÁêÜ</h3>
                        <div v-for="(cat, index) in categoryData" :key="'cat'+index" class="setting-row">
                            <input v-model="cat.main" placeholder="Â§ßÈ°û" style="width: 70px;">
                            <input v-model="cat.subRaw" placeholder="Â∞èÈ°û(ÈÄóËôüÈöîÈñã)" style="flex: 1;">
                            <div class="move-btns">
                                <button @click="moveItem(categoryData, index, -1)">‚ñ≤</button>
                                <button @click="moveItem(categoryData, index, 1)">‚ñº</button>
                            </div>
                            <button @click="categoryData.splice(index, 1)" class="btn-del-circle">‚úï</button>
                        </div>
                        <button @click="categoryData.push({main:'', subRaw:''})" class="btn-small">+ Êñ∞Â¢ûÂ§ßÂàÜÈ°û</button>

                        <h3 style="margin-top:20px;">üí≥ ‰ªòÊ¨æÊñπÂºè</h3>
                        <div v-for="(p, index) in payments" :key="'pay'+index" class="setting-row">
                            <input v-model="payments[index]" style="flex:1">
                            <div class="move-btns">
                                <button @click="moveItem(payments, index, -1)">‚ñ≤</button>
                                <button @click="moveItem(payments, index, 1)">‚ñº</button>
                            </div>
                            <button @click="payments.splice(index, 1)" class="btn-del-circle">‚úï</button>
                        </div>
                        <button @click="payments.push('')" class="btn-small">+ Êñ∞Â¢û‰ªòÊ¨æÊñπÂºè</button>
                        <button class="btn" @click="saveSettings" :disabled="loading">
                            <span v-if="loading" class="loading-spinner"></span>
                            {{ loading ? 'ÂêåÊ≠•‰∏≠...' : 'Á¢∫ÂÆöÂÑ≤Â≠ò' }}
                        </button>
                    </div>
                </div>
            </div>
        </transition>

        <div class="modal-overlay" v-if="showAddModal" @click.self="closeModal">
            <div class="modal-content">
                <h3 style="text-align:center">{{ form.id ? '‚úèÔ∏è ‰øÆÊîπÊîØÂá∫' : '‚ú® Êñ∞Â¢ûÊîØÂá∫' }}</h3>
                <div class="category-grid">
                    <div v-for="cat in categoryData" class="cat-btn" :class="{active: selectedMain === cat.main}" @click="selectMain(cat.main)">
                        {{ cat.main || 'Êú™ÂëΩÂêç' }}
                    </div>
                </div>
                <div v-if="selectedMain" class="sub-category-box">
                    <div v-for="sub in getSubCategories(selectedMain)" class="cat-btn-sub" :class="{active: form.subCategory === sub}" @click="form.subCategory = sub">
                        {{ sub }}
                    </div>
                </div>
                <div class="form-group">
                    <input type="date" v-model="form.date">
                    <input type="text" placeholder="ÂìÅÈ†Ö" v-model="form.item">
                    <input type="number" placeholder="ÈáëÈ°ç" v-model="form.amount">
                    <select v-model="form.payment">
                        <option value="" disabled>‰ªòÊ¨æÊñπÂºè</option>
                        <option v-for="p in payments" :value="p">{{ p }}</option>
                    </select>
                    <textarea placeholder="ÂÇôË®ª" v-model="form.note" rows="2"></textarea>
                    <div style="margin-top:10px; border: 1px dashed #ccc; padding: 10px; border-radius: 10px;">
                        <label style="font-size: 12px; color: #888; display: block; margin-bottom: 5px;">üì∑ ÂúñÁâáÁÆ°ÁêÜÔºö</label>
                        <div v-if="form.imageData || form.imageUrl" style="position: relative; margin-bottom: 10px;">
                            <img :src="form.imageData || form.imageUrl" style="width: 100%; border-radius: 8px; display: block;">
                            <button @click="removeImage" class="btn-del-img" type="button">‚úï ÁßªÈô§ÂúñÁâá</button>
                        </div>
                        <input type="file" accept="image/*" @change="handleFileUpload" id="fileInput">
                    </div>
                </div>
                <button class="btn" @click="submitAdd" :disabled="loading">
                    <span v-if="loading" class="loading-spinner"></span>
                    {{ loading ? 'ÂêåÊ≠•‰∏≠...' : 'Á¢∫ÂÆöÂÑ≤Â≠ò' }}
                </button>
                <button v-if="form.id" class="btn btn-danger" @click="deleteLog(form.id)">Âà™Èô§Ê≠§Á≠Ü</button>
                <button class="btn btn-cancel" @click="closeModal">ÂèñÊ∂à</button>
            </div>
        </div>

        <div class="add-btn" @click="openAddModal">
            <i class="fa-solid fa-plus"></i>
        </div>

        <div v-if="lightboxUrl" class="lightbox" @click.self="closeLightbox">
            <img :src="lightboxUrl" :style="zoomStyle" @touchstart="handleTouchStartImg" @touchmove="handleTouchMoveImg" @touchend="handleTouchEndImg" draggable="false">
            <button class="close-btn" @click="closeLightbox">‚úï</button>
        </div>
        
        <transition name="fade">
            <div v-if="toastMsg" class="toast-overlay">
                <div class="toast-box">{{ toastMsg }}</div>
            </div>
        </transition>

        <nav class="bottom-nav">
            <div class="nav-item" :class="{active: activeTab==='list'}" @click="activeTab='list'">
                <i class="fa-solid fa-rectangle-list"></i>
                <div>ÊòéÁ¥∞</div>
            </div>
            <div class="nav-item" :class="{active: activeTab==='chart'}" @click="activeTab='chart'">
                <i class="fa-solid fa-chart-pie"></i>
                <div>Áµ±Ë®à</div>
            </div>
            <div class="nav-item" :class="{active: activeTab==='settings'}" @click="activeTab='settings'">
                <i class="fa-solid fa-gear"></i>
                <div>Ë®≠ÂÆö</div>
            </div>
        </nav>
    </div>
    <script src="script01.js"></script>
</body>
</html>